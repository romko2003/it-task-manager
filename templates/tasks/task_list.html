{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">Tasks</h1>
  <a class="btn btn-success" href="{% url 'tasks:task-create' %}">+ Create task</a>
</div>

<form method="get" class="card card-body mb-3">
  <div class="row g-2 align-items-end">
    <div class="col-md-4">
      <label class="form-label">Search</label>
      <input class="form-control" name="q" value="{{ q }}" placeholder="name or description">
    </div>

    <div class="col-md-2">
      <label class="form-label">Status</label>
      <select class="form-select" name="status">
        <option value="" {% if status == "" %}selected{% endif %}>All</option>
        <option value="todo" {% if status == "todo" %}selected{% endif %}>Todo</option>
        <option value="done" {% if status == "done" %}selected{% endif %}>Done</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Task type</label>
      <select class="form-select" name="task_type">
        <option value="">All</option>
        {% for t in task_types %}
          <option value="{{ t.id }}" {% if task_type_selected|stringformat:"s" == t.id|stringformat:"s" %}selected{% endif %}>
            {{ t.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Priority</label>
      <select class="form-select" name="priority">
        <option value="">All</option>
        {% for val, label in priorities %}
          <option value="{{ val }}" {% if priority_selected == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Assignee</label>
      <select class="form-select" name="assignee">
        <option value="">All</option>
        {% for w in workers %}
          <option value="{{ w.id }}" {% if assignee_selected|stringformat:"s" == w.id|stringformat:"s" %}selected{% endif %}>
            {{ w }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Apply</button>
      <a class="btn btn-outline-secondary" href="{% url 'tasks:task-list' %}">Reset</a>
    </div>
  </div>
</form>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Priority</th>
          <th>Deadline</th>
          <th>Status</th>
          <th>Assignees</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for task in object_list %}
        <tr>
          <td>
            <a href="{% url 'tasks:task-detail' task.id %}">{{ task.name }}</a>
            {% if task.tags.all %}
              <div class="mt-1">
                {% for tag in task.tags.all %}
                  <span class="badge text-bg-secondary">{{ tag.name }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </td>
          <td>{{ task.task_type.name }}</td>
          <td><span class="badge text-bg-info">{{ task.get_priority_display }}</span></td>
          <td>{{ task.deadline|default:"—" }}</td>
          <td>
            {% if task.is_completed %}
              <span class="badge text-bg-success">Done</span>
            {% else %}
              <span class="badge text-bg-warning">Todo</span>
            {% endif %}
          </td>
          <td>
            {% if task.assignees.all %}
              {% for a in task.assignees.all %}
                <span class="badge text-bg-light border">{{ a }}</span>
              {% endfor %}
            {% else %}
              —
            {% endif %}
          </td>
          <td class="text-end">
            <div class="d-flex justify-content-end gap-2">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'tasks:task-update' task.id %}">Edit</a>
              <a class="btn btn-sm btn-outline-danger" href="{% url 'tasks:task-delete' task.id %}">Delete</a>
              <form method="post" action="{% url 'tasks:task-toggle' task.id %}">
                {% csrf_token %}
                {% if task.is_completed %}
                  <button class="btn btn-sm btn-outline-secondary" type="submit">Undo</button>
                {% else %}
                  <button class="btn btn-sm btn-outline-success" type="submit">Complete</button>
                {% endif %}
              </form>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted py-4">No tasks found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if is_paginated %}
<nav class="mt-3">
  <ul class="pagination">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ status }}&task_type={{ task_type_selected }}&priority={{ priority_selected }}&assignee={{ assignee_selected }}">Prev</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Prev</span></li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    </li>

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ status }}&task_type={{ task_type_selected }}&priority={{ priority_selected }}&assignee={{ assignee_selected }}">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}
